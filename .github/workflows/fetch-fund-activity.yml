name: Fetch Fund Activity

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Fund Activity from Etherscan
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');

          // Known institutional fund wallets (Ethereum)
          const KNOWN_FUNDS = {
            // Galaxy Digital - verified active wallets
            '0x15abb66ba754f05cbc0165a64a11cded1543de48': { name: 'Galaxy Digital', logo: 'ðŸŒŒ', type: 'Investment Firm' },
            '0x33566c9d8be6cf0b23795e0d380e112be9d75836': { name: 'Galaxy Digital', logo: 'ðŸŒŒ', type: 'Investment Firm' },

            // DWF Labs
            '0x53c902a9ef069f3b85e5e71f918c4d582f3063fa': { name: 'DWF Labs', logo: 'ðŸ”·', type: 'Market Maker' },

            // Wintermute
            '0xdbf5e9c5206d0db70a90108bf936da60221dc080': { name: 'Wintermute', logo: 'â„ï¸', type: 'Market Maker' },

            // Jump Trading
            '0x9507c04b10486547584c37bcbd931b2a4fee9a41': { name: 'Jump Trading', logo: 'ðŸ¦˜', type: 'Trading Firm' },

            // Amber Group
            '0x0548f59fee79f8832c299e01dca5c76f034f558e': { name: 'Amber Group', logo: 'ðŸŸ ', type: 'Trading Firm' },
          };

          // Major tokens to track
          const TOKENS = {
            '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2': { symbol: 'WETH', decimals: 18 },
            '0xdac17f958d2ee523a2206206994597c13d831ec7': { symbol: 'USDT', decimals: 6 },
            '0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48': { symbol: 'USDC', decimals: 6 },
            '0x2260fac5e5542a773aa44fbcfedf7c193bc2c599': { symbol: 'WBTC', decimals: 8 },
            '0xae7ab96520de3a18e5e111b5eaab095312d7fe84': { symbol: 'stETH', decimals: 18 },
            '0x6b175474e89094c44da98b954eedeac495271d0f': { symbol: 'DAI', decimals: 18 },
          };

          function fetchUrl(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    console.log('Parse error, raw:', data.substring(0, 200));
                    reject(e);
                  }
                });
                res.on('error', reject);
              }).on('error', reject);
            });
          }

          async function getEthPrice() {
            try {
              const data = await fetchUrl('https://api.coingecko.com/api/v3/simple/price?ids=ethereum,bitcoin&vs_currencies=usd');
              console.log('Prices:', JSON.stringify(data));
              return { eth: data.ethereum?.usd || 2700, btc: data.bitcoin?.usd || 97000 };
            } catch (e) {
              console.log('Price fetch error:', e.message);
              return { eth: 2700, btc: 97000 };
            }
          }

          async function getTokenTransfers(address, apiKey) {
            // Using Etherscan V2 API (V1 is deprecated)
            const url = `https://api.etherscan.io/v2/api?chainid=1&module=account&action=tokentx&address=${address}&page=1&offset=100&sort=desc&apikey=${apiKey}`;

            try {
              const data = await fetchUrl(url);
              console.log(`  API response status: ${data.status}, message: ${data.message}, results: ${data.result?.length || 0}`);

              if (data.status === '1' && Array.isArray(data.result)) {
                return data.result;
              }
              return [];
            } catch (e) {
              console.error(`  Error: ${e.message}`);
              return [];
            }
          }

          async function main() {
            const apiKey = process.env.ETHERSCAN_API_KEY;
            console.log('API Key configured:', apiKey ? 'YES (' + apiKey.substring(0,4) + '...)' : 'NO');

            console.log('Fetching fund activity...');
            const prices = await getEthPrice();
            console.log(`ETH: $${prices.eth}, BTC: $${prices.btc}`);

            const activities = [];
            const fundAddresses = Object.keys(KNOWN_FUNDS);

            for (const address of fundAddresses) {
              const fund = KNOWN_FUNDS[address];
              console.log(`Checking ${fund.name} (${address.slice(0, 10)}...)`);

              const transfers = await getTokenTransfers(address, apiKey);
              let matched = 0;

              for (const tx of transfers) {
                const tokenAddr = tx.contractAddress?.toLowerCase();
                const tokenInfo = TOKENS[tokenAddr];

                if (!tokenInfo) continue;

                const decimals = parseInt(tx.tokenDecimal) || tokenInfo.decimals;
                const amount = parseFloat(tx.value) / Math.pow(10, decimals);

                // Calculate USD value
                let amountUsd = amount;
                if (['WETH', 'stETH'].includes(tokenInfo.symbol)) {
                  amountUsd = amount * prices.eth;
                } else if (tokenInfo.symbol === 'WBTC') {
                  amountUsd = amount * prices.btc;
                }

                // Only $100k+ transactions
                if (amountUsd < 100000) continue;

                const isIncoming = tx.to?.toLowerCase() === address.toLowerCase();
                matched++;

                activities.push({
                  id: `fund-${tx.hash?.slice(0, 16)}-${tokenInfo.symbol}`,
                  timestamp: parseInt(tx.timeStamp) * 1000,
                  fund: fund.name,
                  logo: fund.logo,
                  type: fund.type,
                  action: isIncoming ? 'buy' : 'sell',
                  symbol: tokenInfo.symbol,
                  amount: amount,
                  amountUsd: amountUsd,
                  hash: tx.hash,
                  from: tx.from,
                  to: tx.to,
                });
              }

              console.log(`  Found ${matched} qualifying transactions`);

              // Rate limit
              await new Promise(r => setTimeout(r, 200));
            }

            console.log(`Total new activities: ${activities.length}`);

            // Sort by timestamp
            activities.sort((a, b) => b.timestamp - a.timestamp);

            // Save (replace old data if we have new data)
            if (activities.length > 0) {
              const output = {
                lastUpdated: new Date().toISOString(),
                count: activities.length,
                minValueUsd: 100000,
                activities: activities.slice(0, 100)
              };

              fs.writeFileSync('fund-activity.json', JSON.stringify(output, null, 2));
              console.log(`Saved ${activities.length} fund activities`);
            } else {
              console.log('No new activities found, keeping existing data');
            }
          }

          main().catch(e => {
            console.error('Fatal error:', e);
            process.exit(1);
          });
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add fund-activity.json
          git diff --staged --quiet || git commit -m "Update fund activity $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push
