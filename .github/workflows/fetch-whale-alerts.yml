name: Fetch Whale Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Manual trigger

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Whale Alerts from RSS
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');

          const RSS_URL = 'https://rss.app/feeds/XYfK5HZoXf2jtWrJ.xml';

          function fetchRSS(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
                res.on('error', reject);
              }).on('error', reject);
            });
          }

          function parseItem(itemXml) {
            const getTag = (tag) => {
              const match = itemXml.match(new RegExp(`<${tag}[^>]*>([\\s\\S]*?)<\\/${tag}>`));
              return match ? match[1].trim() : '';
            };

            const title = getTag('title');
            const pubDate = getTag('pubDate');
            const guid = getTag('guid');
            const link = getTag('link');

            // Parse whale alert format: "1,234 #BTC (≈ $123,456,789)"
            const regex = /(\d{1,3}(?:,\d{3})*(?:\.\d+)?)\s*#([A-Z]{2,10})\s*\(.*?\$\s*([\d,]+)/i;
            const match = title.match(regex);

            if (!match) return null;

            const [, amountStr, symbol, usdStr] = match;
            const amount = parseFloat(amountStr.replace(/,/g, ''));
            const amountUsd = parseFloat(usdStr.replace(/,/g, ''));

            // Only include significant transactions ($1M+)
            if (amountUsd < 1000000) return null;

            // Determine blockchain
            let blockchain = 'unknown';
            if (['BTC', 'WBTC'].includes(symbol)) blockchain = 'bitcoin';
            else if (['ETH', 'WETH', 'stETH'].includes(symbol)) blockchain = 'ethereum';
            else if (['USDT', 'USDC', 'DAI', 'BUSD'].includes(symbol)) blockchain = 'ethereum';
            else if (symbol === 'SOL') blockchain = 'solana';
            else if (symbol === 'XRP') blockchain = 'ripple';
            else if (symbol === 'TRX') blockchain = 'tron';

            // Parse from/to from title
            const fromToMatch = title.match(/from\s+([^\s]+)\s+to\s+([^\s]+)/i) ||
                               title.match(/([^\s]+)\s+(?:to|→)\s+([^\s]+)/i);

            let fromOwner = 'Unknown';
            let toOwner = 'Unknown';
            let fromType = 'unknown';
            let toType = 'unknown';

            if (fromToMatch) {
              fromOwner = fromToMatch[1].replace(/#/g, '');
              toOwner = fromToMatch[2].replace(/#/g, '');
            }

            // Detect exchanges
            const exchanges = ['binance', 'coinbase', 'kraken', 'bitfinex', 'huobi', 'okx', 'bybit', 'kucoin', 'gemini', 'bitstamp', 'crypto.com', 'gate.io'];
            if (exchanges.some(e => fromOwner.toLowerCase().includes(e))) fromType = 'exchange';
            if (exchanges.some(e => toOwner.toLowerCase().includes(e))) toType = 'exchange';

            // Determine significance
            let significance = 'high';
            if (amountUsd >= 500000000) significance = 'extreme';
            else if (amountUsd >= 100000000) significance = 'very_high';

            return {
              id: guid || `whale-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
              timestamp: new Date(pubDate).getTime(),
              blockchain,
              symbol,
              amount,
              amountUsd,
              from: {
                address: '',
                owner: fromOwner,
                ownerType: fromType
              },
              to: {
                address: '',
                owner: toOwner,
                ownerType: toType
              },
              transactionType: 'transfer',
              hash: link || '',
              significance
            };
          }

          async function main() {
            try {
              console.log('Fetching RSS feed...');
              const xml = await fetchRSS(RSS_URL);

              // Extract items
              const itemMatches = xml.match(/<item>[\s\S]*?<\/item>/g) || [];
              console.log(`Found ${itemMatches.length} items in RSS`);

              const alerts = [];
              for (const itemXml of itemMatches) {
                const parsed = parseItem(itemXml);
                if (parsed) {
                  alerts.push(parsed);
                }
              }

              // Sort by timestamp descending
              alerts.sort((a, b) => b.timestamp - a.timestamp);

              // Keep last 100 alerts
              const finalAlerts = alerts.slice(0, 100);

              const output = {
                lastUpdated: new Date().toISOString(),
                count: finalAlerts.length,
                minValueUsd: 1000000,
                alerts: finalAlerts
              };

              fs.writeFileSync('alerts.json', JSON.stringify(output, null, 2));
              console.log(`Saved ${finalAlerts.length} whale alerts`);

            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
          }

          main();
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add alerts.json
          git diff --staged --quiet || git commit -m "Update whale alerts $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push
