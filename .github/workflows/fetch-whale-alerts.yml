name: Fetch Whale Alerts

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Whale Alerts from Telegram
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');

          const TELEGRAM_URL = 'https://t.me/s/whale_alert_io';

          function fetchPage(url) {
            return new Promise((resolve, reject) => {
              https.get(url, {
                headers: {
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
                res.on('error', reject);
              }).on('error', reject);
            });
          }

          function parseMessages(html) {
            const alerts = [];

            // Match message blocks
            const messageRegex = /<div class="tgme_widget_message_bubble"[\s\S]*?<div class="tgme_widget_message_text[^"]*"[^>]*>([\s\S]*?)<\/div>[\s\S]*?<time[^>]*datetime="([^"]+)"/g;

            let match;
            while ((match = messageRegex.exec(html)) !== null) {
              const text = match[1].replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
              const datetime = match[2];

              // Parse whale alert format: "1,234 #BTC ... $123,456,789"
              const amountMatch = text.match(/([\d,]+(?:\.\d+)?)\s*#([A-Z]{2,10})/i);
              const usdMatch = text.match(/\$\s*([\d,]+(?:\.\d+)?)/);

              if (amountMatch && usdMatch) {
                const symbol = amountMatch[2].toUpperCase();
                const amount = parseFloat(amountMatch[1].replace(/,/g, ''));
                const amountUsd = parseFloat(usdMatch[1].replace(/,/g, ''));

                // Only $1M+ transactions
                if (amountUsd < 1000000) continue;

                // Determine blockchain
                let blockchain = 'unknown';
                if (['BTC', 'WBTC'].includes(symbol)) blockchain = 'bitcoin';
                else if (['ETH', 'WETH', 'stETH'].includes(symbol)) blockchain = 'ethereum';
                else if (['USDT', 'USDC', 'DAI', 'BUSD'].includes(symbol)) blockchain = 'stablecoin';
                else if (symbol === 'SOL') blockchain = 'solana';
                else if (symbol === 'XRP') blockchain = 'ripple';
                else if (symbol === 'TRX') blockchain = 'tron';
                else if (symbol === 'BNB') blockchain = 'binance';

                // Parse from/to
                let fromOwner = 'unknown';
                let toOwner = 'unknown';
                let fromType = 'unknown';
                let toType = 'unknown';

                const transferMatch = text.match(/from\s+([#\w\.\-]+)\s+(?:to|→)\s+([#\w\.\-]+)/i) ||
                                     text.match(/([#\w\.\-]+)\s+(?:to|→)\s+([#\w\.\-]+)/i);

                if (transferMatch) {
                  fromOwner = transferMatch[1].replace(/#/g, '').trim();
                  toOwner = transferMatch[2].replace(/#/g, '').trim();
                }

                // Detect exchanges
                const exchanges = ['binance', 'coinbase', 'kraken', 'bitfinex', 'huobi', 'okx', 'okex', 'bybit', 'kucoin', 'gemini', 'bitstamp', 'crypto.com', 'gate.io', 'bitget', 'mexc'];
                if (exchanges.some(e => fromOwner.toLowerCase().includes(e))) fromType = 'exchange';
                if (exchanges.some(e => toOwner.toLowerCase().includes(e))) toType = 'exchange';

                // Detect known wallets
                if (fromOwner.toLowerCase().includes('unknown')) fromType = 'unknown';
                if (toOwner.toLowerCase().includes('unknown')) toType = 'unknown';

                // Significance
                let significance = 'high';
                if (amountUsd >= 500000000) significance = 'extreme';
                else if (amountUsd >= 100000000) significance = 'very_high';

                alerts.push({
                  id: `whale-${Date.parse(datetime)}-${symbol}-${Math.random().toString(36).substr(2, 6)}`,
                  timestamp: Date.parse(datetime),
                  blockchain,
                  symbol,
                  amount,
                  amountUsd,
                  from: { address: '', owner: fromOwner, ownerType: fromType },
                  to: { address: '', owner: toOwner, ownerType: toType },
                  transactionType: 'transfer',
                  hash: '',
                  significance
                });
              }
            }

            return alerts;
          }

          async function main() {
            try {
              console.log('Fetching Telegram channel...');
              const html = await fetchPage(TELEGRAM_URL);

              console.log(`Got ${html.length} bytes`);

              const alerts = parseMessages(html);

              // Sort by timestamp descending
              alerts.sort((a, b) => b.timestamp - a.timestamp);

              // Keep unique (by symbol + timestamp combo)
              const seen = new Set();
              const uniqueAlerts = alerts.filter(a => {
                const key = `${a.symbol}-${a.timestamp}-${a.amountUsd}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
              });

              // Load existing alerts
              let existingAlerts = [];
              try {
                const existing = fs.readFileSync('alerts.json', 'utf8');
                existingAlerts = JSON.parse(existing).alerts || [];
              } catch (e) {
                // File doesn't exist yet
              }

              // Merge with existing, keeping last 200
              const allAlerts = [...uniqueAlerts, ...existingAlerts];
              const seenIds = new Set();
              const finalAlerts = allAlerts.filter(a => {
                if (seenIds.has(a.id)) return false;
                seenIds.add(a.id);
                return true;
              }).slice(0, 200);

              const output = {
                lastUpdated: new Date().toISOString(),
                count: finalAlerts.length,
                minValueUsd: 1000000,
                alerts: finalAlerts
              };

              fs.writeFileSync('alerts.json', JSON.stringify(output, null, 2));
              console.log(`Saved ${finalAlerts.length} whale alerts (${uniqueAlerts.length} new)`);

            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
          }

          main();
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add alerts.json
          git diff --staged --quiet || git commit -m "Update whale alerts $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push
