name: Fetch Market Data

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Fear & Greed Index
        run: |
          curl -s "https://api.alternative.me/fng/?limit=1" | \
          node -e "
            let data = '';
            process.stdin.on('data', c => data += c);
            process.stdin.on('end', () => {
              const json = JSON.parse(data);
              const fng = json.data?.[0];
              if (fng) {
                const output = {
                  value: parseInt(fng.value),
                  text: fng.value_classification,
                  timestamp: fng.timestamp,
                  updatedAt: new Date().toISOString()
                };
                require('fs').writeFileSync('feargreed.json', JSON.stringify(output, null, 2));
                console.log('Fear & Greed:', output.value, output.text);
              }
            });
          "

      - name: Fetch Dominance & Market Cap
        run: |
          curl -s "https://api.coingecko.com/api/v3/global" | \
          node -e "
            let data = '';
            process.stdin.on('data', c => data += c);
            process.stdin.on('end', () => {
              try {
                const json = JSON.parse(data);
                const d = json.data;
                if (d) {
                  const output = {
                    btcDominance: parseFloat(d.market_cap_percentage?.btc?.toFixed(2)) || 0,
                    ethDominance: parseFloat(d.market_cap_percentage?.eth?.toFixed(2)) || 0,
                    usdtDominance: parseFloat(d.market_cap_percentage?.usdt?.toFixed(2)) || 0,
                    totalMarketCap: d.total_market_cap?.usd || 0,
                    marketCapChange24h: parseFloat(d.market_cap_change_percentage_24h_usd?.toFixed(2)) || 0,
                    timestamp: Date.now(),
                    updatedAt: new Date().toISOString()
                  };
                  require('fs').writeFileSync('dominance.json', JSON.stringify(output, null, 2));
                  console.log('BTC.D:', output.btcDominance + '%', 'MCap:', (output.totalMarketCap/1e12).toFixed(2) + 'T');
                }
              } catch (e) {
                console.error('CoinGecko error:', e.message);
              }
            });
          "

      - name: Fetch Top 100 Coins (for Crypto Bubbles)
        run: |
          curl -s "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=1h,24h,7d,30d" | \
          node -e "
            let data = '';
            process.stdin.on('data', c => data += c);
            process.stdin.on('end', () => {
              try {
                const coins = JSON.parse(data);
                if (Array.isArray(coins) && coins.length > 0) {
                  const output = {
                    coins: coins.map(c => ({
                      id: c.id,
                      symbol: c.symbol,
                      name: c.name,
                      image: c.image,
                      current_price: c.current_price,
                      market_cap: c.market_cap,
                      market_cap_rank: c.market_cap_rank,
                      price_change_percentage_1h: c.price_change_percentage_1h_in_currency,
                      price_change_percentage_24h: c.price_change_percentage_24h,
                      price_change_percentage_7d: c.price_change_percentage_7d_in_currency,
                      price_change_percentage_30d: c.price_change_percentage_30d_in_currency,
                    })),
                    count: coins.length,
                    timestamp: Date.now(),
                    updatedAt: new Date().toISOString()
                  };
                  require('fs').writeFileSync('coins.json', JSON.stringify(output, null, 2));
                  console.log('Coins fetched:', output.count);
                }
              } catch (e) {
                console.error('Coins fetch error:', e.message);
              }
            });
          "

      - name: Fetch Funding Rates
        run: |
          node << 'EOF'
          const https = require('https');
          const fs = require('fs');

          function fetch(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    console.log('Parse error for', url, ':', data.substring(0, 100));
                    resolve(null);
                  }
                });
                res.on('error', reject);
              }).on('error', reject);
            });
          }

          async function main() {
            try {
              console.log('Fetching Binance funding rates...');

              const [btcFunding, ethFunding, btcOI, ethOI] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1'),
                fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=ETHUSDT&limit=1'),
                fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=BTCUSDT'),
                fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=ETHUSDT'),
              ]);

              console.log('BTC Funding raw:', JSON.stringify(btcFunding));
              console.log('BTC OI raw:', JSON.stringify(btcOI));

              const output = {
                btc: {
                  fundingRate: parseFloat(btcFunding?.[0]?.fundingRate || '0'),
                  fundingRatePercent: parseFloat(btcFunding?.[0]?.fundingRate || '0') * 100,
                  nextFundingTime: parseInt(btcFunding?.[0]?.fundingTime || '0'),
                  markPrice: parseFloat(btcFunding?.[0]?.markPrice || '0'),
                  openInterest: parseFloat(btcOI?.openInterest || '0'),
                },
                eth: {
                  fundingRate: parseFloat(ethFunding?.[0]?.fundingRate || '0'),
                  fundingRatePercent: parseFloat(ethFunding?.[0]?.fundingRate || '0') * 100,
                  nextFundingTime: parseInt(ethFunding?.[0]?.fundingTime || '0'),
                  markPrice: parseFloat(ethFunding?.[0]?.markPrice || '0'),
                  openInterest: parseFloat(ethOI?.openInterest || '0'),
                },
                timestamp: Date.now(),
                updatedAt: new Date().toISOString()
              };

              fs.writeFileSync('funding.json', JSON.stringify(output, null, 2));
              console.log('BTC Funding:', output.btc.fundingRatePercent.toFixed(4) + '%', 'OI:', output.btc.openInterest);
              console.log('ETH Funding:', output.eth.fundingRatePercent.toFixed(4) + '%', 'OI:', output.eth.openInterest);
            } catch (e) {
              console.error('Binance error:', e.message, e.stack);
            }
          }

          main();
          EOF

      - name: Commit and Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add feargreed.json dominance.json funding.json coins.json
          git diff --staged --quiet || git commit -m "Update market data $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push
